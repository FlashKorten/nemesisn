<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
	  <link rel="stylesheet" href="list.css" type="text/css" media="screen"/>
    <script type="text/javascript" src="jquery.min.js"> </script>
    <script type="text/javascript">

      $(document).ready(function() {
        getDrillerJson();
        $('body').on('click', 'ul.selector li', function() { updateList(this) });
      });

function collectParams() {
  var query = "";
  $('ul.selector li.entry.selected').each(function() {
    var category = $(this).parent().attr('id');
    var value = $(this).find('div.value').text();
    if (value) {
      query += ((query === "") ? "" : "&")
            + category + "=" + value;
    }
  });
  console.log("Query: "+query);
  return query;
}

function getDrillerJson() {
  $.getJSON("http://bohr/driller/q", collectParams(), function(data){
  updateSelector(data, "Authors", "author");
  updateSelector(data, "Publishers", "publisher");
  updateSelector(data, "Genres", "genre");
  updateSelector(data, "Series", "series");
  updateSelector(data, "Mechanics", "mechanic");
  updateSelector(data, "Themes", "theme");
  updateSelector(data, "Engines", "engine");
  updateSelector(data, "Parties", "party");
  updateSelector(data, "Latitudes", "latitude");
  updateSelector(data, "Longitudes", "longitude");
  updateSelector(data, "FromYears", "fromYear");
  updateSelector(data, "UpToYears", "upToYear");
  updateSelector(data, "FromRanges", "fromRange");
  updateSelector(data, "UpToRanges", "upToRange");
  $('#info').empty().append('#scenarios: '+ data["NoResults"]);
  });
}

getGroupInfo = function(e) {
  var category = e.parent().attr('id') + "Group/";
  if (e.parent().hasClass('map')) {
    var idGetter = getId;
    var valueGetter = getName;
  } else {
    var idGetter = getValue;
    var valueGetter = getValue;
  }
  var catId = e.find('div.value').text();
  console.log("getGroupInfo: "+ category +" = "+catId);
  $.getJSON("http://bohr/driller/"+category+catId, collectParams(), function(data) {
    var g = "<ul>";
    for (d in data) {
      console.log(d);
      console.log("Foo: "+idGetter(data[d])+", Bar: "+valueGetter(data[d]));
      g += "<li class='entry'><div class='value'>"+idGetter(data[d])+"<\/div><div class='text'>"+valueGetter(data[d])+"<\/div><\/li>";
    }
    e.removeClass("group");
    e.empty().append(g + "<\/ul>");
  });
}

updateList = function(item) {
  var e = $(item);
  var list = e.parent();
  if (e.hasClass('header')) {
    var hidden_siblings = e.siblings('.hidden');
    if (hidden_siblings.length > 0) {
      hidden_siblings.removeClass('hidden');
    } else {
      e.siblings().addClass('hidden');
    }
  } else if (e.hasClass('entry')) {
    if (e.hasClass('selected')){
      var hidden_siblings = e.siblings('.hidden');
      if (hidden_siblings.length > 0) {
        e.siblings().removeClass('hidden');
      } else {
        e.siblings().addClass('hidden');
      }
    } else {
      while (!list.hasClass('selector')){
        list = list.parent();
      }
      e.addClass('selected');
      list.empty();
      list.append(e);
      list.append(getClearFilterLI());
      getDrillerJson();
    }
  } else if (e.hasClass('group')) {
    getGroupInfo(e);
  } else if (e.hasClass('reset')) {
    e.siblings('.selected').removeClass('selected');
    getDrillerJson();
  }
}

updateSelector = function(data, f1, f2) {
  var category = $('#'+f2+'.selector');
  if (category.hasClass('map')) {
    var idGetter = getId;
    var valueGetter = getName;
  } else {
    var idGetter = getValue;
    var valueGetter = getValue;
  }
  var selected = $('#'+f2+'.selector li.selected');
  if (selected.length > 0 && selected.find('div.value').text() !== "") {
    var dp = data[f1].Entries[0];
    selected.parent().empty().append(
        getClearFilterLI() +
        "<li class='entry selected'><div class='value'>"+idGetter(dp)+"<\/div><div id='text'>"+valueGetter(dp)+"<\/div><\/li>");
    return;
  }
  var g = "<li class='header'><div class='value'><\/div><div class='text'>Filter "+f2+"(";
  if (data[f1].Groups != undefined) {
    var gr = "";
    var num = 0;
    for (d in data[f1].Groups) {
      num += data[f1].Groups[d]["Matches"];
      gr += "<li class='group hidden'><div class='value'>"+data[f1].Groups[d].GroupId+"<\/div><div class='text'>"+data[f1].Groups[d].GroupId+"  ("+data[f1].Groups[d].Matches+")<\/div><\/li>";
    }
    g += num+")<\/div><\/li>"+gr;
  } else if (data[f1].Entries.length >= 0) {
    g += data[f1].Entries.length+')<\/div><\/li>'
    for (d in data[f1].Entries) {
      var dp = data[f1].Entries[d];
      g += "<li class='entry hidden'><div class='value'>"+idGetter(dp)+"<\/div><div class='text'>"+valueGetter(dp)+"<\/div><\/li>";
    }
  }
  $('#'+f2).empty().append(g);
}

getId = function(data){
  return data["Id"];
}

getName = function(data){
  return data["Name"];
}

getValue = function(data){
  return data["Value"];
}

getGameValue = function(data){
  return data["Title"]+((data["Subtitle"].length > 0) ? " &mdash; "+data["Subtitle"] : "");
}

getClearFilterLI = function() {
  return "<li class='reset hidden'><div class='value'><\/div><div class='text'>Clear filter<\/div><\/li>";
}

    </script>
    <title>JS-Test</title>
  </head>
  <body>
      <div class='selector'>
        <ul class='selector map' id='author'>
          <li><div class='value'></div><div class='text'>Author</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='publisher'>
          <li><div class='value'></div><div class='text'>Publisher</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='series'>
          <li><div class='value'></div><div class='text'>Series</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='engine'>
          <li><div class='value'></div><div class='text'>Engine</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='theme'>
          <li><div class='value'></div><div class='text'>Theme</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='mechanic'>
          <li><div class='value'></div><div class='text'>Mechanic</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='genre'>
          <li><div class='value'></div><div class='text'>Genre</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector map' id='party'>
          <li><div class='value'></div><div class='text'>Party</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector value' id='latitude'>
          <li><div class='value'></div><div class='text'>Latitude</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector value' id='longitude'>
          <li><div class='value'></div><div class='text'>Longitude</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector value' id='fromYear'>
          <li><div class='value'></div><div class='text'>FromYear</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector value' id='upToYear'>
          <li><div class='value'></div><div class='text'>UpToYear</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector value' id='fromRange'>
          <li><div class='value'></div><div class='text'>FromRange</div></li>
        </ul>
      </div>
      <div class='selector'>
        <ul class='selector value' id='upToRange'>
          <li><div class='value'></div><div class='text'>UpToRange</div></li>
        </ul>
      </div>
    <p id="info"></p>
  </body>
</html>
